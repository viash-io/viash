name: ns test

on: [push]

jobs:
  ns-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up java (& sbt)
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '11'

    - name: Set up sbt when it isn't provided by temurin
      run: |
        if ! command -v sbt &> /dev/null; then
          # instructions as per https://www.scala-sbt.org/release/docs/Installing-sbt-on-Linux.html, but added -y to install commands
          sudo apt-get update
          sudo apt-get install -y apt-transport-https curl gnupg -yqq
          echo "deb https://repo.scala-sbt.org/scalasbt/debian all main" | sudo tee /etc/apt/sources.list.d/sbt.list
          echo "deb https://repo.scala-sbt.org/scalasbt/debian /" | sudo tee /etc/apt/sources.list.d/sbt_old.list
          curl -sL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823" | sudo -H gpg --no-default-keyring --keyring gnupg-ring:/etc/apt/trusted.gpg.d/scalasbt-release.gpg --import
          sudo chmod 644 /etc/apt/trusted.gpg.d/scalasbt-release.gpg
          sudo apt-get update
          sudo apt-get install -y sbt
        fi

    - name: Build viash
      run: |
        echo "${HOME}/.local/bin" >> $GITHUB_PATH
        ./configure --prefix "${HOME}/.local/"
        make
        make install

    - name: Run tests
      run: |
        set -e
        viash ns test --src src/viash
